---
# tasks file for k8master
 - name: "checking for k8 repo"
   file:
           path: "/etc/yum.repos.d/kubernetes.repo"
           state: touch
   register: x
 - name: "confguring repo for K8s"
   shell:  |
                cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
                [kubernetes]
                name=Kubernetes
                baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch
                enabled=1
                gpgcheck=1
                repo_gpgcheck=1
                gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
                EOF
   when: x["diff"]["before"]["state"]!="file"

 - name: installing docker
   package:
           name: "docker"
           state: present

 - name: "starting the docker service"
   service:
           name: "docker"
           state: started
           enabled: yes

 - name: "installing kubeadm"
   package:
           name: "kubeadm"
           state: present

 - name: "starting the kubelet service"
   service:
           name: "kubelet"
           state: started
           enabled: yes

 - name: "pulling all the docker images for cluster"
   command: "kubeadm config images pull"

 - name: "setting up driver docker cgroup to use systemd instead of cgroupfs"
   copy:
           dest: "/etc/docker/daemon.json"
           content: '{
                      "exec-opts": ["native.cgroupdriver=systemd"]
                     }'

 - name: "restarting docker service"
   service:
           name: "docker"
           state: restarted

 - name: "installing iproute-tc software for traffic control"
   package:
           name: "iproute-tc"
           state: present

 - name: "creating a file"
   file:
           path: "/etc/sysctl.d/k8s.conf"
           state: touch
           group: "root"
           owner: "root"
           mode: 0644
 - name: "network configuration"
   blockinfile:
           path: "/etc/sysctl.d/k8s.conf"
           block: |
                   net.bridge.bridge-nf-call-ip6tables = 1
                   net.bridge.bridge-nf-call-iptables = 1
           state: present

 - name: " Starting sysctl service"
   command: "sysctl --system"

 - name: "Ignoring RAM and CPU errors(system requirements)"
   shell: "kubeadm init --pod-network-cidr=10.240.0.0/16 --ignore-preflight-errors=NumCPU --ignore-preflight-errors=Mem --ignore-preflight-errors=Swap"
 - name: "setting up environement "
   shell: "mkdir -p $HOME/.kube;cp -i /etc/kubernetes/admin.conf $HOME/.kube/config;chown $(id -u):$(id -g) $HOME/.kube/config;"
 - name: "Running flannel pod "
   command: "kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml"
 - name: "Getting token....."
   command: "kubeadm token create --print-join-command"
   register: token
 - debug:
         msg: " Master configured"

 - name: "Copy this token to Worker Node"
   debug:
           var: token['stdout']
